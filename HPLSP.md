High Performance Linux Server Programming

# 一、TCP/IP协议族

## 1.1 TCP/IP协议族体系结构及主要协议

TCP/IP协议族是自底向上的四层协议系统。

### 1.1.1 数据链路层

**该层实现了网卡接口的网络驱动程序，用以处理数据在物理媒介（如以太网、令牌环等）上的传输。**

本层常用协议：**ARP协议**（Address Resolve Protocol，地址解析协议）和RARP协议（Reverse Address Resolve Protocol，逆地址解析协议）。它们实现了IP地址和机器物理地址（通常是MAC地址）之间的相互转换。

网络层使用IP地址寻址一台机器，数据链路层使用物理地址寻址一台机器。因此网络层需将IP地址转换为物理地址才能使用数据链路层提供的服务，这便是ARP协议的用途。

### 1.1.2 网络层

**该层实现数据包的路由和转发。**WAN（Wide Area Network，广域网）通常使用众多分级的路由器来连接分散的主机或LAN（Local Area Network，局域网），因此通信的两台主机一般是通过多个中间节点（路由器）间接连接的。**网络层的任务就是选择这些中间节点，以确定两台主机之间的通信路径。**网络层对上层协议隐藏了网络拓扑链接的细节，使得在传输层和网络应用程序看来，通信的双方是直接相连的。

网络层最核心的协议是**IP协议**（Internet Protocol，因特网协议）。IP协议根据数据包的目标IP地址决定如何投递它。若数据包不能直接发送给目标主机，IP协议就为它寻找合适的下一跳（next hop）路由器，经过多次这样的逐跳（hop by hop）的方式数据包最终被送达目标主机，或者由于发送失败而被丢弃。

网络层另一个重要协议是**ICMP协议**（Internet Control Message Protoco，因特网控制报文协议）。它是IP协议的重要补充，主要用于检测网络连接。需要指出的是该协议并非严格的网络层协议，因为它使用同一层的IP协议提供的服务（一般来说，上层协议使用下层协议提供的服务）。

### 1.1.3 传输层

**该层为两台主机上的应用程序提供端到端（end to end）的通信。**与网络层不同，传输层不关心数据包的中转过程，只在乎通信的起始端和目的端。传输层为应用程序封装了一条端到端的逻辑通信链路，它负责数据的收发、链路的超时重连等。

传输层的第一个主要协议是**TCP协议**（Transmission Contro Protoc，传输控制协议），它为应用层提供可靠的、面向连接的和基于流（stream）的服务。TCP协议使用超时重传、数据确认等方式确保数据包被正确的发送至目的端，因此TCP协议是可靠的。使用TCP协议通信的双方必须先建立TCP连接，并在内核中为该连接维持一些必要的数据结构，比如连接的状态、读写缓冲区，以及诸多定时器等。当通信结束时，双方必须关闭连接已释放这些内核数据。TCP服务是基于流的。基于流的数据没有边界（长度）限制，它源源不断地从通信的一端流入另一端。发送端可以逐个字节地向流写入数据，接收端也可以逐个字节地将它们读出。

与TCP协议相对应的另一个传输层主要协议是**UDP协议**（User Datagram Protocol，用户数据报协议），它为应用层提供不可靠、无连接和基于数据报的服务。“不可靠”意味着UDP协议无法保证数据从发送端正确地传送到目的端。如果数据在中途丢失，或者目的端通过数据校验发现数据错误而将其丢弃，则UDP协议只是简单地通知应用程序发送失败。无连接意味着应用程序每次发送数据都要明确指定接收端的地址。基于数据报的服务，是相对于流的服务而言，每个UDP数据包都有一个长度，接收端必须以该长度的最小单位将其所有内容一次性读出，否则数据将被截断。

### 1.1.4 应用层

**该层负责处理应用程序的逻辑。**此下的三层负责处理网络通信细节，这部分必须既稳定又高效，因此它们都在内核空间中实现。而应用层则在用户空间实现。

ping是应用程序，而不是协议，它利用ICMP报文检测网络连接，是调试网络环境的必备工具。**telnet协议**是一种远程登录协议，它使我们能在本地完成远程任务。**OSPF**（Open Shortest Path First，开放最短路径优先）协议是一种动态路由更新协议，用于路由器之间的通信，以告知对方各自的路由信息。**DNS**（Domain Name Service，域名服务）协议提供机器域名到IP地址的转换。

## 1.2 封装

上层协议通过封装（encapsulation）使用下层协议提供的服务。即，应用程序数据发送到物理网络上之前，将沿着协议栈从上往下依次传递。每层协议都将在上层数据的基础上加上自己的头部信息（有时也包括尾部信息），以实现该层的功能。

经TCP封装后的数据称为TCP报文段（TCP message segment），简称TCP段。TCP协议为通信双方维持的连接信息存储在内核中的TCP头部信息和TCP内核发送缓冲区中，正是这两部分一起构成了TCP报文段。

经UDP封装后的数据称为UDP数据报（UDP datagram）。与TCP报文段不同的是，UDP无需为应用层数据保存副本，当一个UDP数据报超过发出后，UDP内核缓冲区的该数据报就被丢弃（因为它提供的是不可靠的服务，无需维护这些信息）。如需重新发送该数据报，应用程序需要重新从用户空间将数据拷贝到UDP内核发送缓冲区中。

经IP封装后的数据成为IP数据包（IP datagram）。它包含IP头部信息和数据部分，数据部分就是一个TCP报文段、UPD数据报或者ICMP报文。

经数据链路层封装的数据称为帧（frame）。传输媒介不同，帧的类型也不同。比如，以太网上传输的是以太网帧（Ethernet frame），而令牌环网络上传输的是令牌环帧（token ring frame）。

帧才是最终在物理网络上传输的字节序列。至此，封装过程完成。

## 1.3 分用

当帧到达目的主机是，将沿着协议栈自底向上依次传递。各层协议一次处理帧中本层负责的头部数据，一获取所需信息，最终将处理后的帧交给目标应用程序。这个过程称为分用（demultiplexing）。**分用是依靠头部信息中的类型字段实现的。**

这里算是解释了各层协议的数据报文中的报文类型是做什么的了，它的作用是表明本层的服务是为谁提供的，因为上层可能有多个协议都是用该协议提供的服务，多个协议通过类型来判断这个报文应该发送给上层的哪一个协议模块。

## 1.4 测试网络

## 1.5 ARP协议工作原理

**ARP协议能够实现任意网络层地址（IP地址）到任意物理地址（MAC地址）的转换。**其工作原理是：主机向自己所在的网络广播一个ARP请求，该请求包含目标机器的网络地址。此网络中的其他机器都将收到这个请求，但只有被请求的目标机器会回应一个ARP应答，其中包含了被请求机器的物理地址。

### 1.5.1 以太网ARP请求/应答报文详解

格式如下（括号内为字节长度）：
```
| 硬件类型(2) | 协议类型(2) | 硬件地址长度(1) | 协议地址长度(1) | 操作(2) | 发送(2) |~
~| 发送端以太网地址(6) | 发送端IP地址(4) | 目的端以太网地址(6) | 目的端IP地址(4) |
```
### 1.5.2 ARP高速缓存的查看和修改

通常，ARP维护一个（动态变化的）高速缓存，其中包含进程访问（比如网关地址）或最近访问的机器的IP地址到物理地址的映射。如此便避免了重复的ARP请求，提高了发送数据包的速度。

### 1.5.3 使用tcpdump观察ARP通信过程

## 1.6 DNS工作原理

### 1.6.1 DNS查询和应答报文详解

DNS是一套分布式的域名服务系统。每个DNS服务器上都存放着大量的机器名和IP地址的映射，并且是动态更新的。众多网络客户端程序都是用DNS协议来向DNS服务器查询目标主机的IP地址。

```
| 16位标识 | 16位标志 | 16位问题个数 | 16位应答资源记录个数 |~
~| 16位授权资源记录数目 | 16位额外的资源记录数目 |~
~| 查询问题(变长) | 应答(资源记录数目可变，变长) |~
~| 授权(资源记录数目可变，变长) |~
~| 额外信息(资源记录数目可变，变长) |
```

- 标识用于标识一对DNS查询和应答，以此区分一个DNS应答是哪个DNS查询的回应。
- 标志字段用于协商具体的通信方式和反馈通信状态。
- 接下来的四个字段分别指出DNS报文的最后4个字段的资源记录数目。
    - 对查询报文而言，它一般包含1个查询问题，而应答资源记录数、授权资源记录数和额外资源记录数则为0。
    - 应答报文的应答资源记录数则至少为1，而授权资源记录数和额外资源记录数可为0或非0。
- 查询问题字段包含三部分：查询名（封装好的要查询的主机名）、查询类型（如何执行查询，如获取主机IP地址、获取主机别名、反向查询）和查询类（通常为1，标识获取IP地址）。
- 应答字段、授权字段和额外信息字段都使用资源记录（Resource Record，RR）格式（包括32位域名、16位类型、16位类、32位生存时间、16位资源数据长度和变长的资源数据）。

**递归查询**是指如果目标DNS服务器无法解析请求的主机名则会向其他DNS服务器继续查询，如此递归，直到获得结果并把该结果返回给客户端。
**迭代查询**是指如果目标DNS服务器无法解析请求的主机名则会将自己知道的其他DNS服务器的IP地址返回给客户端，以供客户端参考。

### 1.6.2 Linux下访问DNS服务

Linux下的DNS服务器地址存放文件：`/etc/resolv.conf`
Linux下常用的访问DNS服务器的客户端程序是`host`

### 1.6.3 使用tcpdump观察DNS通信过程

## 1.7 socket和TCP/IP协议族的关系

