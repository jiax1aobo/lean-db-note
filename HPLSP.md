High Performance Linux Server Programming

# 一、TCP/IP协议族

## 1.1 TCP/IP协议族体系结构及主要协议

TCP/IP协议族是自底向上的四层协议系统。

### 1.1.1 数据链路层

**该层实现了网卡接口的网络驱动程序，用以处理数据在物理媒介（如以太网、令牌环等）上的传输。**

本层常用协议：**ARP协议**（Address Resolve Protocol，地址解析协议）和RARP协议（Reverse Address Resolve Protocol，逆地址解析协议）。它们实现了IP地址和机器物理地址（通常是MAC地址）之间的相互转换。

网络层使用IP地址寻址一台机器，数据链路层使用物理地址寻址一台机器。因此网络层需将IP地址转换为物理地址才能使用数据链路层提供的服务，这便是ARP协议的用途。

### 1.1.2 网络层

**该层实现数据包的路由和转发。**WAN（Wide Area Network，广域网）通常使用众多分级的路由器来连接分散的主机或LAN（Local Area Network，局域网），因此通信的两台主机一般是通过多个中间节点（路由器）间接连接的。**网络层的任务就是选择这些中间节点，以确定两台主机之间的通信路径。**网络层对上层协议隐藏了网络拓扑链接的细节，使得在传输层和网络应用程序看来，通信的双方是直接相连的。

网络层最核心的协议是**IP协议**（Internet Protocol，因特网协议）。IP协议根据数据包的目标IP地址决定如何投递它。若数据包不能直接发送给目标主机，IP协议就为它寻找合适的下一跳（next hop）路由器，经过多次这样的逐跳（hop by hop）的方式数据包最终被送达目标主机，或者由于发送失败而被丢弃。

网络层另一个重要协议是**ICMP协议**（Internet Control Message Protoco，因特网控制报文协议）。它是IP协议的重要补充，主要用于检测网络连接。需要指出的是该协议并非严格的网络层协议，因为它使用同一层的IP协议提供的服务（一般来说，上层协议使用下层协议提供的服务）。

### 1.1.3 传输层

**该层为两台主机上的应用程序提供端到端（end to end）的通信。**与网络层不同，传输层不关心数据包的中转过程，只在乎通信的起始端和目的端。传输层为应用程序封装了一条端到端的逻辑通信链路，它负责数据的收发、链路的超时重连等。

传输层的第一个主要协议是**TCP协议**（Transmission Contro Protoc，传输控制协议），它为应用层提供可靠的、面向连接的和基于流（stream）的服务。TCP协议使用超时重传、数据确认等方式确保数据包被正确的发送至目的端，因此TCP协议是可靠的。使用TCP协议通信的双方必须先建立TCP连接，并在内核中为该连接维持一些必要的数据结构，比如连接的状态、读写缓冲区，以及诸多定时器等。当通信结束时，双方必须关闭连接已释放这些内核数据。TCP服务是基于流的。基于流的数据没有边界（长度）限制，它源源不断地从通信的一端流入另一端。发送端可以逐个字节地向流写入数据，接收端也可以逐个字节地将它们读出。

与TCP协议相对应的另一个传输层主要协议是**UDP协议**（User Datagram Protocol，用户数据报协议），它为应用层提供不可靠、无连接和基于数据报的服务。“不可靠”意味着UDP协议无法保证数据从发送端正确地传送到目的端。如果数据在中途丢失，或者目的端通过数据校验发现数据错误而将其丢弃，则UDP协议只是简单地通知应用程序发送失败。无连接意味着应用程序每次发送数据都要明确指定接收端的地址。基于数据报的服务，是相对于流的服务而言，每个UDP数据包都有一个长度，接收端必须以该长度的最小单位将其所有内容一次性读出，否则数据将被截断。

### 1.1.4 应用层

**该层负责处理应用程序的逻辑。**此下的三层负责处理网络通信细节，这部分必须既稳定又高效，因此它们都在内核空间中实现。而应用层则在用户空间实现。

ping是应用程序，而不是协议，它利用ICMP报文检测网络连接，是调试网络环境的必备工具。**telnet协议**是一种远程登录协议，它使我们能在本地完成远程任务。**OSPF**（Open Shortest Path First，开放最短路径优先）协议是一种动态路由更新协议，用于路由器之间的通信，以告知对方各自的路由信息。**DNS**（Domain Name Service，域名服务）协议提供机器域名到IP地址的转换。

## 1.2 封装

上层协议通过封装（encapsulation）使用下层协议提供的服务。即，应用程序数据发送到物理网络上之前，将沿着协议栈从上往下依次传递。每层协议都将在上层数据的基础上加上自己的头部信息（有时也包括尾部信息），以实现该层的功能。

经TCP封装后的数据称为TCP报文段（TCP message segment），简称TCP段。TCP协议为通信双方维持的连接信息存储在内核中的TCP头部信息和TCP内核发送缓冲区中，正是这两部分一起构成了TCP报文段。

经UDP封装后的数据称为UDP数据报（UDP datagram）。与TCP报文段不同的是，UDP无需为应用层数据保存副本，当一个UDP数据报超过发出后，UDP内核缓冲区的该数据报就被丢弃（因为它提供的是不可靠的服务，无需维护这些信息）。如需重新发送该数据报，应用程序需要重新从用户空间将数据拷贝到UDP内核发送缓冲区中。

经IP封装后的数据成为IP数据包（IP datagram）。它包含IP头部信息和数据部分，数据部分就是一个TCP报文段、UPD数据报或者ICMP报文。

经数据链路层封装的数据称为帧（frame）。传输媒介不同，帧的类型也不同。比如，以太网上传输的是以太网帧（Ethernet frame），而令牌环网络上传输的是令牌环帧（token ring frame）。

帧才是最终在物理网络上传输的字节序列。至此，封装过程完成。

## 1.3 分用

当帧到达目的主机是，将沿着协议栈自底向上依次传递。各层协议一次处理帧中本层负责的头部数据，一获取所需信息，最终将处理后的帧交给目标应用程序。这个过程称为分用（demultiplexing）。**分用是依靠头部信息中的类型字段实现的。**

这里算是解释了各层协议的数据报文中的报文类型是做什么的了，它的作用是表明本层的服务是为谁提供的，因为上层可能有多个协议都是用该协议提供的服务，多个协议通过类型来判断这个报文应该发送给上层的哪一个协议模块。

## 1.4 测试网络

## 1.5 ARP协议工作原理

**ARP协议能够实现任意网络层地址（IP地址）到任意物理地址（MAC地址）的转换。**其工作原理是：主机向自己所在的网络广播一个ARP请求，该请求包含目标机器的网络地址。此网络中的其他机器都将收到这个请求，但只有被请求的目标机器会回应一个ARP应答，其中包含了被请求机器的物理地址。

### 1.5.1 以太网ARP请求/应答报文详解

格式如下（括号内为字节长度）：
```
| 硬件类型(2) | 协议类型(2) | 硬件地址长度(1) | 协议地址长度(1) | 操作(2) | 发送(2) |~
~| 发送端以太网地址(6) | 发送端IP地址(4) | 目的端以太网地址(6) | 目的端IP地址(4) |
```
### 1.5.2 ARP高速缓存的查看和修改

通常，ARP维护一个（动态变化的）高速缓存，其中包含进程访问（比如网关地址）或最近访问的机器的IP地址到物理地址的映射。如此便避免了重复的ARP请求，提高了发送数据包的速度。

### 1.5.3 使用tcpdump观察ARP通信过程

## 1.6 DNS工作原理

### 1.6.1 DNS查询和应答报文详解

DNS是一套分布式的域名服务系统。每个DNS服务器上都存放着大量的机器名和IP地址的映射，并且是动态更新的。众多网络客户端程序都是用DNS协议来向DNS服务器查询目标主机的IP地址。

```
| 16位标识 | 16位标志 | 16位问题个数 | 16位应答资源记录个数 |~
~| 16位授权资源记录数目 | 16位额外的资源记录数目 |~
~| 查询问题(变长) | 应答(资源记录数目可变，变长) |~
~| 授权(资源记录数目可变，变长) |~
~| 额外信息(资源记录数目可变，变长) |
```

- 标识用于标识一对DNS查询和应答，以此区分一个DNS应答是哪个DNS查询的回应。
- 标志字段用于协商具体的通信方式和反馈通信状态。
- 接下来的四个字段分别指出DNS报文的最后4个字段的资源记录数目。
    - 对查询报文而言，它一般包含1个查询问题，而应答资源记录数、授权资源记录数和额外资源记录数则为0。
    - 应答报文的应答资源记录数则至少为1，而授权资源记录数和额外资源记录数可为0或非0。
- 查询问题字段包含三部分：查询名（封装好的要查询的主机名）、查询类型（如何执行查询，如获取主机IP地址、获取主机别名、反向查询）和查询类（通常为1，标识获取IP地址）。
- 应答字段、授权字段和额外信息字段都使用资源记录（Resource Record，RR）格式（包括32位域名、16位类型、16位类、32位生存时间、16位资源数据长度和变长的资源数据）。

**递归查询**是指如果目标DNS服务器无法解析请求的主机名则会向其他DNS服务器继续查询，如此递归，直到获得结果并把该结果返回给客户端。
**迭代查询**是指如果目标DNS服务器无法解析请求的主机名则会将自己知道的其他DNS服务器的IP地址返回给客户端，以供客户端参考。

### 1.6.2 Linux下访问DNS服务

Linux下的DNS服务器地址存放文件：`/etc/resolv.conf`
Linux下常用的访问DNS服务器的客户端程序是`host`

### 1.6.3 使用tcpdump观察DNS通信过程

## 1.7 socket和TCP/IP协议族的关系

由于数据链路层、网络层和传输层协议是在内核中实现的，因此操作系统提供了一组系统调用来让应用程序能够访问这些协议提供的服务。实现这组系统调用的API主要有两套：socket（常用）和XTI（基本不使用）。

由socket实现的这一组API提供两点功能：
1. 将应用程序数据从用户缓冲区中复制到TCP/UDP内核发送缓冲区，以交付内核来发送数据，或者是从内核TCP/UDP内核接收缓冲区中复制数据到用户缓冲区，以读取数据。
2. 应用程序可以通过这组API来修改内核中各层协议的某些头部信息或者其他数据结构，从而精细地控制底层通信的行为。

socket是一套通用的网络编程接口，它不但可以访问内核中TCP/IP协议栈，而且可以访问其他网络协议栈（如X.25协议栈、UNIX本地域协议栈等）。

# 二、IP协议详解

- IP头部信息：IP头部出现在每个IP数据报中，用于指定IP通信的源端IP地址、目的端IP地址，指导IP分片和重组，以及指定部分通信行为。
- IP数据报的路由和转发：IP数据报的路由和转发发生在除目标机器之外的所有主机和路由器上。它们决定数据包是否应该转发以及如何转发。

## 2.1 IP服务的特点

IP协议是TCP/IP协议族的动力，它为上层协议提供无状态、无连接、不可靠的服务。
- **无状态**：IP通信的双方不同步传输数据的状态信息，因此所有IP数据报的发送、传输和接收都是相互独立、没有上下文关系的。这种服务的最大缺点就是无法处理乱序和重复的IP数据报。先发出的数据报可能比后发出的数据报先到达，同一个数据报也可能经由不同路径多次到达接收端。**接收端的IP模块只要收到了完整的IP数据报（如果是IP分片的话，IP模块将先执行重组），就将其数据部分（TCP报文段、UDP数据报或ICMP报文）上交给上层协议。**虽然IP数据报头部提供了一个标识字段用以唯一标识一个IP数据报，但它是被用来处理IP分片和重组的，而不是用来指示接收顺序的。**无状态服务的有点也很明显，那就是简单、高效。**
- **无连接**：IP通信双方都不长久地维持对方的任何信息。这样，上层协议每次发送数据的时候，都必须明确指定对方的IP地址。
- **不可靠**：IP协议不能保证IP数据报准确地到达接收端。例如某个中专路由器发现IP数据报在网络中存活时间太长，就将丢弃它并返回一个ICMP（超时）错误信息给发送端，又或者接收端发现收到的IP数据报不正确，也将丢弃之，也将发送一个ICMP（IP头部参数）错误信息给发送端。无论哪种情况，发送端的IP模块一旦检测到IP数据报发送失败，就通知上层协议发送失败，但并不会试图重传。所以，使用IP服务的上层协议（如TCP协议）需自己实现数据确认、超时重传等机制以达到可靠传输的目的。

## 2.2 IPv4头部结构

### 2.2.1 IPv4头部结构

IPv4的头部通常为20字节，除非含有可变长的选项部分。

```
| 4位版本号 | 4位头部长度 | 8位服务类型(TOS) | 16位总长度(字节数) |~
| 16位标识 | 3位标志 | 13位片偏移 |~
| 8位生存时间(TTL) | 8位协议 | 16位头部校验和 |~
| 32位源端IP地址 | 32位目的端IP地址 | 选项，最多40字节 |
```

- **4位版本号（version）**：对IPv4来说，值为4。其他IPv4协议的拓展版本（如SIP协议，PIP协议）则有不同版本号，且它们也有不同的头部结构。
- **4位头部长度（header length）**：标识该IP头部有多少个32bit字，所以4位最大能表示60字节的头部。
- **8位服务类型（Type Of Service，TOS）**：包含3位优先权字段（现已忽略），4位TOS字段和1位保留字段（必须置0）。4位TOS字段分别表示：最小延时，最大吞吐量，最高可靠性和最小费用。其中最多只有一位能置为1，应用应根据实际需要来设置它。
- **16位总长度（total length）**：指整个IP数据报的长度，以字节为单位（理论最大长度为$2^{16}-1$字节），但由于MTU的限制，导致超过MTU的数据报将被分片传输，所以实际传输的IP数据报长度远没有达到做大值。
- **16位标识（identification）**：**用于实现分片。**唯一地标识主机发送的每一个数据报。其初始值由系统随机生成：每发送一个数据报，其值就加1。该标识在同一个IP数据报的多个分片中是相同的。
- **3位标志字段**：**用于实现分片。**第一位保留，第二位表示“禁止分片”（Don't Fragment）。若设置了DF位，IP模块就不会对数据报进行分片，如果IP数据报长度超过MTU则会放弃该数据报并返回ICMP错误报文。第三位表示“更多分片”（More Fragment）。除了数据报的最后一个分片，其他分片都要把它置1。
- **13位分片偏移（fragmentation offset）**：**用于实现分片。**是分片相对于原始IP数据报开始处（仅指数据部分）的偏移。实际的偏移是该值左移3位后得到的，也就是说除了最后一个IP分片外，每个IP分片的数据部分的长度必须是8的整数倍。
- **8位生存时间（Time To Live，TTL）**：是数据报到达目的地之前允许经过的路由器跳数，由发送端设置。数据报在转发过程中每经过一个路由就减1。当TTL减为0时，路由器就丢弃该数据报并向发送端发送ICMP差错报文。**TTL可以防止数据报陷入路由循环。**
- **8位协议（protocol）**：用来区分上层协议（即该IP数据报被哪个上层协议模块使用，如ICMP为1，TCP为6，UDP为17）。
- **16位头部校验和（header checksum）**：由发送端填充，接收端使用CRC算法检验IP数据报**头部**在传输过程中是否损坏。
- **32位源端IP地址和目的端IP地址**：用来标识数据报的发送端和接收端。一般情况下，这两个地址在整个传递过程中保持不变。
- **选项字段（option）**：可变长的可选信息（最多包含40字节）。IP选项包括：
  - 记录路由（record route），记录所有传递过程中经过的路由器IP地址。
  - 时间戳（timestamp），记录每个路由器转发的时间。
  - 松散源路由选择（loose source routing），指定一个路由器IP地址列表，数据报发送过程中必须经过其中所有的路由器。
  - 严格源路由选择（strict source routing），和松散源路由选择类似，不过数据报只能经过指定的路由器。


### 2.2.2 使用tcpdump观察IPv4头部结构

## 2.3 IP分片

当IP数据报长度超过MTU时，它将被分片传输。分片可能发生在发送端，也可能发生在中专路由器上，且可能在传输过程中被多次分片，但只有在最终的目标机器上，这些分片才会被内核IP模块重新组装。

IP层传递给数据链路层的数据可能是一个完整的IP数据报，也可能是一个IP分片，它们统称为IP分组（packet）。后续无特殊声明，不区分IP数据报和IP分组。

## 2.4 IP路由

IP协议的一个核心任务是数据包的路由，即决定发送数据包到目标机器的路径。

### 2.4.1 IP模块工作流程

